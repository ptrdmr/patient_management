{% extends 'patient_records/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared/notes-modal.css' %}">
<style>
.content-wrapper {
    display: flex;
    gap: 1rem;
    padding: 1rem;
}

.main-content {
    flex: 1;
    min-width: 0;
}

.notes-sidebar {
    width: 300px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1rem;
}

.patient-header {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.records-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.record-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 1rem;
}

.record-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.record-card h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #2c3e50;
}

.record-actions {
    display: flex;
    gap: 0.5rem;
}

.record-list {
    max-height: 300px;
    overflow-y: auto;
}

.record-item {
    padding: 0.5rem;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.record-item:hover {
    background-color: #f8f9fa;
}

.record-item:last-child {
    border-bottom: none;
}

.record-date {
    font-size: 0.9em;
    color: #666;
}

.btn-add {
    padding: 0.25rem 0.5rem;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.btn-add:hover {
    background: #45a049;
}

.btn-view-all {
    padding: 0.25rem 0.5rem;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.btn-view-all:hover {
    background: #1e88e5;
}

.vital-record {
    padding: 15px 0;
}

.vital-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.vital-details {
    padding-left: 15px;
    border-left: 3px solid #e0e0e0;
}

.vital-details p {
    margin: 5px 0;
}

.view-all-link {
    margin-top: 15px;
    text-align: right;
}

hr {
    margin: 15px 0;
    border: 0;
    border-top: 1px solid #e0e0e0;
}

.btn-link {
    padding: 0;
    color: #007bff;
    text-decoration: none;
}

.btn-link:hover {
    color: #0056b3;
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="patient-header">
    <div class="header-info">
        <h1>{{ patient.first_name }} {{ patient.last_name }}</h1>
        <div class="patient-meta">
            <span>DOB: {{ patient.date_of_birth|date:"M d, Y" }}</span>
            <span>•</span>
            <span>Gender: {{ patient.get_gender_display }}</span>
            <span>•</span>
            <span>ID: {{ patient.patient_number }}</span>
        </div>
    </div>
</div>

<div class="content-wrapper">
    <div class="main-content">
        <div class="records-grid">
            <!-- Vitals -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-heartbeat"></i> Vitals</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_vitals' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="vitals">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if recent_vitals %}
                    {% for vital in recent_vitals|slice:":5" %}
                    <div class="record-item" data-record-id="{{ vital.id }}">
                        <div class="record-date">{{ vital.date|date:"M d, Y" }}</div>
                        <div>BP: {{ vital.blood_pressure }}</div>
                        <div>Pulse: {{ vital.pulse }} bpm</div>
                        <div>Temp: {{ vital.temperature }}°F</div>
                        <div>O2 Sat: {{ vital.spo2 }}%</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No vitals recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Medications -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-pills"></i> Medications</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_medications' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="medications">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if current_medications %}
                    {% for med in current_medications|slice:":5" %}
                    <div class="record-item" data-record-id="{{ med.id }}">
                        <div class="record-date">{{ med.date_prescribed|date:"M d, Y" }}</div>
                        <strong>{{ med.drug }}</strong> {{ med.dose }}
                        <div>{{ med.frequency }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No medications recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Diagnoses -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-stethoscope"></i> Diagnoses</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_diagnosis' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="diagnoses">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if active_diagnoses %}
                    {% for diagnosis in active_diagnoses|slice:":5" %}
                    <div class="record-item" data-record-id="{{ diagnosis.id }}">
                        <div class="record-date">{{ diagnosis.date|date:"M d, Y" }}</div>
                        <strong>{{ diagnosis.diagnosis }}</strong>
                        <div>{{ diagnosis.icd_code }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No diagnoses recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Lab Results - CBC -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-vial"></i> CBC Labs</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_cbc_labs' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="cbc_labs">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if cbc_labs %}
                    {% for lab in cbc_labs|slice:":5" %}
                    <div class="record-item" data-record-id="{{ lab.id }}">
                        <div class="record-date">{{ lab.date|date:"M d, Y" }}</div>
                        <div>WBC: {{ lab.wbc }}</div>
                        <div>RBC: {{ lab.rbc }}</div>
                        <div>HGB: {{ lab.hemoglobin }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No CBC labs recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Lab Results - CMP -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-vial"></i> CMP Labs</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_cmp_labs' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="cmp_labs">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if cmp_labs %}
                    {% for lab in cmp_labs|slice:":5" %}
                    <div class="record-item" data-record-id="{{ lab.id }}">
                        <div class="record-date">{{ lab.date|date:"M d, Y" }}</div>
                        <div>Sodium: {{ lab.sodium }}</div>
                        <div>Potassium: {{ lab.potassium }}</div>
                        <div>Glucose: {{ lab.glucose }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No CMP labs recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Symptoms -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-notes-medical"></i> Symptoms</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_symptoms' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="symptoms">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if symptoms %}
                    {% for symptom in symptoms|slice:":5" %}
                    <div class="record-item" data-record-id="{{ symptom.id }}">
                        <div class="record-date">{{ symptom.date|date:"M d, Y" }}</div>
                        <strong>{{ symptom.symptom }}</strong>
                        {% if symptom.severity %}
                        <div>Severity: {{ symptom.get_severity_display }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No symptoms recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Visits -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-hospital"></i> Visits</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_visit' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="visits">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if visits %}
                    {% for visit in visits|slice:":5" %}
                    <div class="record-item" data-record-id="{{ visit.id }}">
                        <div class="record-date">{{ visit.date|date:"M d, Y" }}</div>
                        <strong>{{ visit.visit_type }}</strong>
                        <div>{{ visit.provider }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No visits recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Measurements -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-weight"></i> Measurements</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_measurements' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="measurements">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if measurements %}
                    {% for measurement in measurements|slice:":5" %}
                    <div class="record-item" data-record-id="{{ measurement.id }}">
                        <div class="record-date">{{ measurement.date|date:"M d, Y" }}</div>
                        <div>Weight: {{ measurement.weight }} lbs</div>
                        {% if measurement.pps %}
                        <div>PPS: {{ measurement.pps }}%</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No measurements recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- ADLs -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-tasks"></i> ADLs</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_adls' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="adls">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if adls %}
                    {% for adl in adls|slice:":5" %}
                    <div class="record-item" data-record-id="{{ adl.id }}">
                        <div class="record-date">{{ adl.date|date:"M d, Y" }}</div>
                        <div>Ambulation: {{ adl.get_ambulation_display }}</div>
                        <div>Feeding: {{ adl.get_feeding_display }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No ADLs recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Imaging -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-x-ray"></i> Imaging</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_imaging' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="imaging">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if imaging %}
                    {% for image in imaging|slice:":5" %}
                    <div class="record-item" data-record-id="{{ image.id }}">
                        <div class="record-date">{{ image.date|date:"M d, Y" }}</div>
                        <strong>{{ image.type }}</strong>
                        <div>{{ image.body_part }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No imaging recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Occurrences -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-exclamation-circle"></i> Occurrences</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_occurrence' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="occurrences">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if occurrences %}
                    {% for occurrence in occurrences|slice:":5" %}
                    <div class="record-item" data-record-id="{{ occurrence.id }}">
                        <div class="record-date">{{ occurrence.date|date:"M d, Y" }}</div>
                        <strong>{{ occurrence.occurrence_type }}</strong>
                        <div>{{ occurrence.description|truncatechars:100 }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No occurrences recorded</p>
                    {% endif %}
                </div>
            </div>

            <!-- Record Requests -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-file-medical"></i> Record Requests</h3>
                    <div class="record-actions">
                        <a href="{% url 'add_record_request' patient.id %}" class="btn-add">
                            <i class="fas fa-plus"></i> Add
                        </a>
                        <a href="#" class="btn-view-all" data-section="record_requests">View All</a>
                    </div>
                </div>
                <div class="record-list">
                    {% if record_requests %}
                    {% for request in record_requests|slice:":5" %}
                    <div class="record-item" data-record-id="{{ request.id }}">
                        <div class="record-date">{{ request.date|date:"M d, Y" }}</div>
                        <strong>{{ request.request_type }}</strong>
                        <div>Status: {{ request.get_status_display }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No record requests</p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="record-card">
                <div class="record-card-header">
                    <h3><i class="fas fa-history"></i> Recent Activities</h3>
                </div>
                <div class="record-list">
                    {% if recent_activities %}
                    {% for activity in recent_activities|slice:":5" %}
                    <div class="record-item">
                        <div class="record-date">{{ activity.timestamp|date:"M d, Y H:i" }}</div>
                        <div>{{ activity.action }}</div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No recent activities</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="notes-sidebar">
        {% include 'patient_records/partials/_notes_list.html' with notes=notes %}
    </div>
</div>

{% include 'patient_records/partials/_note_form.html' %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/patient_detail.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle record item clicks
    document.querySelectorAll('.record-item').forEach(item => {
        item.addEventListener('click', function() {
            const recordId = this.dataset.recordId;
            const recordType = this.closest('.record-card')
                                 .querySelector('h3')
                                 .textContent.trim()
                                 .toLowerCase()
                                 .replace(/\s+/g, '_')  // Convert "CBC Labs" to "cbc_labs"
                                 .replace(/\s*labs$/i, '_labs');  // Ensure "Labs" becomes "_labs"
            if (recordId) {
                window.location.href = `/patient/record/${recordType}/${recordId}/`;
            }
        });
    });

    // Handle view all clicks
    document.querySelectorAll('.btn-view-all').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.dataset.section;
            window.location.href = `/patient/{{ patient.id }}/records/${section}/`;
        });
    });
});
</script>
{% endblock %}