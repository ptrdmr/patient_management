{% load static %}

<div class="notes-section">
    <div class="section-header">
        <h2>Patient Notes</h2>
        <button class="btn btn-primary"
                hx-get="{% url 'load_notes_modal' patient.id %}"
                hx-target="#notes-modal-container"
                hx-trigger="click">
            + New Note
        </button>
    </div>

    <div class="notes-list">
        {% if notes %}
            {% for note in notes %}
                <div class="note-card" id="note-{{ note.id }}">
                    <div class="note-header">
                        <h3>{{ note.get_category_display }}</h3>
                        <span class="category-tag {{ note.category }}">
                            {{ note.get_category_display }}
                        </span>
                    </div>
                    
                    <div class="note-content">
                        {{ note.content|linebreaksbr|truncatewords:30 }}
                    </div>

                    <div class="note-attachments">
                        {% if note.referenced_diagnoses.exists %}
                            {% for diagnosis in note.referenced_diagnoses.all %}
                                <a href="#" class="attachment-link">
                                    üìã {{ diagnosis.diagnosis }}
                                </a>
                            {% endfor %}
                        {% endif %}

                        {% if note.referenced_vitals.exists %}
                            {% for vital in note.referenced_vitals.all %}
                                <a href="#" class="attachment-link">
                                    üìä Vitals {{ vital.date|date:"M d Y" }}
                                </a>
                            {% endfor %}
                        {% endif %}

                        {% if note.referenced_cmp_labs.exists %}
                            {% for lab in note.referenced_cmp_labs.all %}
                                <a href="#" class="attachment-link">
                                    üî¨ Lab Results {{ lab.date|date:"M d Y" }}
                                </a>
                            {% endfor %}
                        {% endif %}

                        {% if note.referenced_cbc_labs.exists %}
                            {% for lab in note.referenced_cbc_labs.all %}
                                <a href="#" class="attachment-link">
                                    üî¨ CBC Results {{ lab.date|date:"M d Y" }}
                                </a>
                            {% endfor %}
                        {% endif %}

                        {% if note.referenced_medications.exists %}
                            {% for med in note.referenced_medications.all %}
                                <a href="#" class="attachment-link">
                                    üíä {{ med.medication_name }}
                                </a>
                            {% endfor %}
                        {% endif %}

                        {% if note.referenced_imaging.exists %}
                            {% for img in note.referenced_imaging.all %}
                                <a href="#" class="attachment-link">
                                    üñºÔ∏è {{ img.imaging_type }} {{ img.date|date:"M d Y" }}
                                </a>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <div class="note-footer">
                        <span class="last-edited">
                            Last edited: {{ note.updated_at|date:"Y-m-d H:i A" }}
                        </span>
                        <div class="note-actions">
                            <button class="btn btn-link"
                                    hx-get="{% url 'load_notes_modal' patient.id %}?note_id={{ note.id }}"
                                    hx-target="#notes-modal-container"
                                    hx-trigger="click"
                                    aria-label="Edit note from {{ note.created_at|date:'M d, Y' }}">
                                Edit
                            </button>
                            <button class="btn btn-link text-danger"
                                    hx-delete="{% url 'delete_note' note.id %}"
                                    hx-confirm="Are you sure you want to delete this note?"
                                    hx-target="#note-{{ note.id }}"
                                    hx-swap="outerHTML"
                                    aria-label="Delete note">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No notes have been added yet.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal container -->
<div id="notes-modal-container"></div>

<style>
    .notes-section {
        padding: 1rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .notes-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .note-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .note-header h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .category-tag {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.875rem;
    }

    .category-tag.clinical {
        background-color: #E3F2FD;
        color: #1976D2;
    }

    .category-tag.medications {
        background-color: #E8F5E9;
        color: #388E3C;
    }

    .category-tag.labs {
        background-color: #FFF3E0;
        color: #F57C00;
    }

    .note-content {
        color: var(--text-color);
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .note-attachments {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .attachment-link {
        color: var(--primary-color);
    }
</style> 